{% extends "base.html" %}

{% block content %}
  {% if page.meta and page.meta.hide %}
    {% set hidden = "hidden" if "navigation" in page.meta.hide %}
  {% endif %}

  {{ super() }}

  <!-- æ·»åŠ è¯„è®ºåŒºï¼ˆåªåœ¨éé¦–é¡µæ˜¾ç¤ºï¼‰ -->
  {% if page.url != "" and page.url != "index.html" %}
    <div class="comments-section" style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--md-default-fg-color--lightest);">
      <h2>ğŸ“ è¯„è®ºåŒº</h2>
      {% include "comments.html" %}
    </div>
  {% endif %}

  <!-- æ·»åŠ è‡ªå®šä¹‰ä¸»é¢˜è‰²é€‰æ‹©å™¨ -->
  <div class="color-picker-container" style="position: fixed; bottom: 2rem; right: 2rem; z-index: 1000;">
    <button id="color-picker-toggle" class="md-button md-button--primary" style="border-radius: 50%; width: 48px; height: 48px; background: var(--md-primary-fg-color); color: white; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
      <i class="fas fa-palette"></i>
    </button>
    <div id="color-picker-menu" style="display: none; position: absolute; bottom: 60px; right: 0; background: var(--md-default-bg-color); border: 1px solid var(--md-default-fg-color--lightest); border-radius: 8px; padding: 12px; min-width: 150px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
      <h4 style="margin-top: 0; margin-bottom: 8px; font-size: 0.9rem; color: var(--md-default-fg-color);">ä¸»é¢˜è‰²</h4>
      <div class="color-options" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
        <button class="color-option" data-color="cyan" style="width: 32px; height: 32px; background: #00bcd4; border: 2px solid transparent; border-radius: 50%; cursor: pointer;"></button>
        <button class="color-option" data-color="indigo" style="width: 32px; height: 32px; background: #3f51b5; border: 2px solid transparent; border-radius: 50%; cursor: pointer;"></button>
        <button class="color-option" data-color="green" style="width: 32px; height: 32px; background: #4caf50; border: 2px solid transparent; border-radius: 50%; cursor: pointer;"></button>
        <button class="color-option" data-color="orange" style="width: 32px; height: 32px; background: #ff9800; border: 2px solid transparent; border-radius: 50%; cursor: pointer;"></button>
        <button class="color-option" data-color="pink" style="width: 32px; height: 32px; background: #e91e63; border: 2px solid transparent; border-radius: 50%; cursor: pointer;"></button>
        <button class="color-option" data-color="purple" style="width: 32px; height: 32px; background: #9c27b0; border: 2px solid transparent; border-radius: 50%; cursor: pointer;"></button>
        <button class="color-option" data-color="teal" style="width: 32px; height: 32px; background: #009688; border: 2px solid transparent; border-radius: 50%; cursor: pointer;"></button>
        <button class="color-option" data-color="blue" style="width: 32px; height: 32px; background: #2196f3; border: 2px solid transparent; border-radius: 50%; cursor: pointer;"></button>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  
  <script>
    // ä¸»é¢˜è‰²åˆ‡æ¢åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
      const toggleButton = document.getElementById('color-picker-toggle');
      const colorMenu = document.getElementById('color-picker-menu');
      const colorOptions = document.querySelectorAll('.color-option');
      
      // åˆ‡æ¢é¢œè‰²é€‰æ‹©å™¨æ˜¾ç¤º
      toggleButton.addEventListener('click', function(e) {
        e.stopPropagation();
        colorMenu.style.display = colorMenu.style.display === 'none' ? 'block' : 'none';
      });
      
      // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸå…³é—­é€‰æ‹©å™¨
      document.addEventListener('click', function(e) {
        if (!colorMenu.contains(e.target) && e.target !== toggleButton) {
          colorMenu.style.display = 'none';
        }
      });
      
      // è®¾ç½®ä¸»é¢˜è‰²
      colorOptions.forEach(option => {
        option.addEventListener('click', function() {
          const color = this.getAttribute('data-color');
          setThemeColor(color);
          localStorage.setItem('theme-color', color);
          colorMenu.style.display = 'none';
          
          // æ›´æ–°é€‰ä¸­çŠ¶æ€
          colorOptions.forEach(opt => {
            opt.style.borderColor = 'transparent';
          });
          this.style.borderColor = 'var(--md-accent-fg-color)';
          this.style.transform = 'scale(1.1)';
        });
      });
      
      // ä»localStorageåŠ è½½ä¿å­˜çš„ä¸»é¢˜è‰²
      const savedColor = localStorage.getItem('theme-color');
      if (savedColor) {
        setThemeColor(savedColor);
        
        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        colorOptions.forEach(option => {
          if (option.getAttribute('data-color') === savedColor) {
            option.style.borderColor = 'var(--md-accent-fg-color)';
            option.style.transform = 'scale(1.1)';
          }
        });
      }
      
      // è®¾ç½®ä¸»é¢˜è‰²çš„å‡½æ•°
      function setThemeColor(color) {
        const root = document.documentElement;
        const body = document.body;
        
        // æ ¹æ®é¢œè‰²è®¾ç½®CSSå˜é‡å’ŒMaterialä¸»é¢˜å±æ€§
        const colors = {
          cyan: {
            primary: 'cyan',
            primaryHex: '#00bcd4',
            accent: 'deep-purple',
            accentHex: '#7c4dff'
          },
          indigo: {
            primary: 'indigo',
            primaryHex: '#3f51b5',
            accent: 'pink',
            accentHex: '#e91e63'
          },
          green: {
            primary: 'green',
            primaryHex: '#4caf50',
            accent: 'orange',
            accentHex: '#ff9800'
          },
          orange: {
            primary: 'orange',
            primaryHex: '#ff9800',
            accent: 'indigo',
            accentHex: '#3f51b5'
          },
          pink: {
            primary: 'pink',
            primaryHex: '#e91e63',
            accent: 'cyan',
            accentHex: '#00bcd4'
          },
          purple: {
            primary: 'purple',
            primaryHex: '#9c27b0',
            accent: 'green',
            accentHex: '#4caf50'
          },
          teal: {
            primary: 'teal',
            primaryHex: '#009688',
            accent: 'deep-orange',
            accentHex: '#ff5722'
          },
          blue: {
            primary: 'blue',
            primaryHex: '#2196f3',
            accent: 'amber',
            accentHex: '#ffc107'
          }
        };
        
        if (colors[color]) {
          // æ›´æ–°CSSå˜é‡
          root.style.setProperty('--md-primary-fg-color', colors[color].primaryHex);
          root.style.setProperty('--md-accent-fg-color', colors[color].accentHex);
          
          // æ›´æ–°Materialä¸»é¢˜çš„dataå±æ€§ï¼ˆå…³é”®ï¼ï¼‰
          body.setAttribute('data-md-color-primary', colors[color].primary);
          body.setAttribute('data-md-color-accent', colors[color].accent);
          
          // æ›´æ–°æŒ‰é’®é¢œè‰²
          toggleButton.style.background = colors[color].primaryHex;
          
          // è§¦å‘Materialä¸»é¢˜æ›´æ–°
          if (typeof document$.dispatchEvent === 'function') {
            const event = new CustomEvent('change', {
              detail: {
                scheme: body.getAttribute('data-md-color-scheme')
              }
            });
            document$.dispatchEvent(event);
          }
          
          console.log('ä¸»é¢˜è‰²å·²åˆ‡æ¢ä¸º:', color, colors[color]);
        }
      }
    });
  </script>
{% endblock %}