<script>

window.MathJax = {

  tex: {

    inlineMath: [['$', '$'], ['\\(', '\\)']],

    displayMath: [['$$', '$$'], ['\\[', '\\]']],

    macros: {

      oiint: "{\\mathchoice{\\mkern-18mu\\iint}{\\mkern-12mu\\iint}{\\mkern-13mu\\iint}{\\mkern-12mu\\iint}}"

    }

  }

};

</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>



# 四、总线与输入输出系统







## 4.1 总线系统







### 总线基本概念







**总线组成**：



* **数据总线**：传输数据，双向



* **地址总线**：传输地址，单向（CPU→外设）



* **控制总线**：传输控制信号，双向







**总线带宽计算**（2009）：



$B = f \times w \times \eta$



$f$：时钟频率，$w$：数据线宽度（字节），$\eta$：传输效率







**总线仲裁**：



* **集中式仲裁**：



    * 链式查询：简单，优先级固定，对故障敏感



    * 计数器定时查询：优先级可编程



    * 独立请求：速度快，控制线多



* **分布式仲裁**：各设备竞争总线







**总线定时**：



* **同步定时**（2014）：时钟信号同步



* **异步定时**（2014）：握手信号同步



    * 全互锁（2015）：可靠，速度慢



    * 非互锁（2015）：速度快，不可靠



* **半同步定时**（2014）：结合两者优点







### 总线标准







**系统总线标准**：



* **ISA**（Industry Standard Architecture）：16位，8MHz



* **EISA**：32位扩展ISA



* **PCI**（Peripheral Component Interconnect）：32/64位，33/66MHz



* **PCI-E**：串行点对点，高速



* **AGP**：专用图形接口







**设备总线标准**：



* **USB**（Universal Serial Bus）：通用串行总线



* **IEEE1394**（FireWire）：高速串行



* **RS-232C**：串行通信标准







**总线桥接器**（2017）：



* 连接不同标准的总线



* 协议转换，速度匹配







### 总线操作与传输







**总线传输方式**：



* **并行传输**（2014）：多线同时传输



* **串行传输**：单线顺序传输



* **猝发传输**（2012）：连续传输多个数据







**信号线复用**（2016）：



* 数地复用（2012）：数据和地址共用线路



* 分时复用，提高线路利用率







**分离事务通信**（2016）：



* 请求和响应分离



* 提高总线利用率







## 4.2 输入输出系统







### I/O编址方式







**统一编址（内存映射I/O）**：



* I/O端口和内存统一编址



* 使用访存指令访问I/O



* 优点：指令丰富，控制简单



* 缺点：占用内存地址空间







**独立编址**（2014）：



* I/O端口单独编址



* 专用I/O指令（IN/OUT）



* 优点：不占内存空间，速度快



* 缺点：指令少，控制复杂







**I/O端口**：



* **数据端口**：传输数据



* **状态端口**：读取设备状态



* **控制端口**：发送控制命令







### I/O控制方式







**程序查询方式**：



1. 读取设备状态寄存器



2. 若设备未就绪，继续轮询



3. 设备就绪后传输数据







**思想**：CPU轮询设备状态



**复杂度**：$O(n)$，CPU利用率低







**中断方式**：



* 设备就绪时发出中断请求



* CPU响应中断，执行中断服务程序



* 优点：CPU可与I/O并行



* 缺点：中断处理开销大







**DMA方式**（Direct Memory Access）：



* 直接内存访问，不需要CPU介入



* DMA控制器管理传输



* 传输方式：



    * **周期挪用**（2020）：DMA窃取CPU周期



    * **停止CPU**：独占总线



    * **交替访问**：时间片轮转



* DMA预处理和后处理（2018）：CPU设置参数和善后







**通道方式**：



* 专用I/O处理器



* 执行通道程序



* 进一步减轻CPU负担







### I/O接口与设备







**接口功能**：



* 数据缓冲：协调速度差异



* 错误检测：奇偶校验等（2013）



* 控制定时：协调数据传输



* 数据格式转换：串并转换等







**常见接口设备**：



* **键盘控制器**（2021-2025）：扫描码转换



* **网络适配器**（网卡，2021-2025）：网络通信



* **打印机适配器**（2021-2025）：打印控制



* **可编程中断控制器**（PIC，2021-2025）：管理中断







**显存带宽计算**（2010）：



$\text{显存带宽} = \text{分辨率} \times \text{颜色深度} \times \text{刷新率}$



例如：1920×1080×32bit×60Hz ≈ 4.0GB/s







## 4.3 外部存储设备







### 磁盘存储器







**磁盘结构**：



* **盘面**（2021-2025）：双面盘片有两个盘面



* **磁道**（2021-2025）：同心圆轨迹



* **扇区**（2013）：磁道分段



* **柱面**：同半径的磁道集合







**磁盘性能指标**：



* **道密度**：沿半径方向单位长度的磁道数



* **位密度**：磁道单位长度存储的位数



* **存储容量**：$C = n \times s \times b$



$n$：盘面数，$s$：每面磁道数，$b$：每道扇区数×每扇区字节数







**磁盘访问时间**（2015）：



$T_a = T_s + \frac{1}{2r} + \frac{b}{rN}$



$T_s$：平均寻道时间，$r$：转速，$b$：传输字节数，$N$：每道字节数







**磁盘调度算法**：



* **FCFS**：先来先服务



* **SSTF**：最短寻道时间优先



* **SCAN**：电梯算法



* **C-SCAN**：循环扫描



* **LOOK/C-LOOK**：改进的SCAN/C-SCAN







**磁盘阵列技术**：



* **条带化**（2013）：数据分块分布到多个磁盘



* **磁盘镜像**（2013）：RAID 1，数据复制



* **奇偶校验**（2013）：RAID 5，分布式校验



# 四、文件系统



## 4.1 文件管理



### 文件概念与操作



**文件控制块（FCB，2009）**：

* 基本信息：文件名、类型、大小等

* 地址信息：文件在外存的地址

* 控制信息：访问权限、时间戳等



**文件操作**：

* 创建、删除、打开、关闭

* 读、写、定位

* 属性设置、重命名



**文件描述符**（2017）：

* 打开文件的索引

* 进程级资源

* 指向系统打开文件表项



**文件类型**：

* 普通文件、目录文件、设备文件

* 按组织方式：顺序文件、索引文件、散列文件



### 目录管理



**目录结构**：

1. **一级目录**（2011）：所有文件在同一目录

2. **二级目录**：主文件目录+用户文件目录

3. **树形目录**（2016）：层次结构，支持路径名

4. **图形目录**：支持共享，可能有环



**目录操作**：

* 创建、删除目录

* 文件检索（2010）：按名存取（2016）

* 目录项：文件名+FCB指针（或i-node号）



**目录实现**：

* 线性列表：简单，查找慢

* 哈希表：查找快，可能有冲突

* B+树：适合大型目录



### 文件分配方式



**连续分配**（2011）：

* 文件占用连续磁盘块

* 优点：顺序访问快，随机访问快

* 缺点：外部碎片，文件扩展难



**链接分配**（2014）：

* **隐式链接**：每个块有指向下一块的指针

* **显式链接**：FAT表（2016）记录链接关系

* 优点：无外部碎片，文件扩展容易

* 缺点：随机访问慢，可靠性差



**索引分配**（2013）：

* **单级索引**：索引块存所有块指针

* **多级索引**：适合大文件

* **混合索引**：UNIX i-node方式

* 直接索引指针（2015）：指向数据块

* 间接索引指针（2015）：指向索引块



**FAT文件系统**（2016）：

* FAT12、FAT16、FAT32

* 簇号（2016）：分配单位

* FAT表项：下一簇号或结束标志



**UNIX i-node**：

* 直接指针：10-12个

* 一级间接：指向索引块

* 二级间接：指向一级间接块

* 三级间接：指向二级间接块



### 文件存储空间管理



**空闲表法**（2024）：

* 记录连续空闲区

* 分配算法类似内存动态分区



**空闲链表法**（2024）：

* 链接所有空闲块

* 分配从链头取，释放加到链尾



**位示图法**（2014）：

* 每个块对应一个二进制位

* 0表示空闲，1表示已分配

* 分配：找值为0的位

* 释放：将对应位置0



**成组链接法**（2024）：

* UNIX方式

* 空闲块分组，组间链接

* 超级块缓存一组空闲块号



**伙伴算法**（2024）：

* 按2的幂次分配块

* 合并相邻空闲块

* 适合内核内存分配



## 4.2 磁盘管理



### 磁盘结构与性能



**磁盘结构**：

* 柱面号、磁头号、扇区号（2013）

* 盘面（2021-2025）、磁道（2021-2025）

* 扇区（2013）：最小可寻址单位

* 温彻斯特硬盘（2025）：密封技术



**磁盘访问时间**：

$T_a = T_s + \frac{1}{2r} + \frac{b}{rN}$

* $T_s$：平均寻道时间（2015）

* $r$：转速（RPM）

* $b$：传输字节数

* $N$：每道字节数



**磁盘格式化**：

* 低级格式化：划分扇区

* 高级格式化：创建文件系统

* 扇区校验码（2017）：错误检测



### 磁盘调度算法



**1. 先来先服务（FCFS）**：

* 按请求顺序服务

* 公平但效率低



**2. 最短寻道时间优先（SSTF，2018）**：

* 选择离当前磁头最近的请求

* 可能产生饥饿现象

* 磁臂黏着（2018）：反复服务同一磁道



**3. 扫描算法（SCAN，2009）**：

* 磁头单向移动，到头后返回

* 类似电梯算法



**4. 循环扫描（C-SCAN，2010）**：

* 单向移动，到头后快速返回起点

* 更公平



**5. N-Step-SCAN**：

* 将请求队列分为N个子队列

* 每个子队列用SCAN算法

* 防止磁臂黏着



**6. FSCAN**：

* 两个队列：当前队列和等待队列

* 当前队列用SCAN服务

* 新请求加入等待队列



**算法比较**：

| 算法 | 平均寻道时间 | 公平性 | 特点 |
|------|--------------|--------|------|
| FCFS | 最长 | 公平 | 简单 |
| SSTF | 较短 | 不公平 | 可能饥饿 |
| SCAN | 中等 | 较公平 | 无饥饿 |
| C-SCAN | 中等 | 公平 | 等待时间均匀 |



### 磁盘可靠性技术



**冗余阵列（RAID）**：

* **条带化**（2013）：数据分布到多个磁盘

* **磁盘镜像**（2013）：RAID 1，完全复制

* **奇偶校验**（2013）：RAID 5，分布式校验

* **均衡磨损**（2025）：延长SSD寿命



**磁盘高速缓存**（2018）：

* 内存中缓存磁盘数据

* 减少磁盘I/O次数



**预读与滞后写**（2012）：

* 预读：提前读入可能访问的数据

* 滞后写：延迟写回，合并写操作



# 五、设备管理



## 5.1 I/O系统



### I/O控制方式



**程序查询方式**：

1. 读取设备状态寄存器

2. 如果设备未就绪，继续轮询

3. 设备就绪后传输数据



**思想**：CPU轮询设备状态

**复杂度**：CPU利用率低



**中断驱动方式**（2011）：

* 设备就绪时发中断

* CPU响应中断处理I/O

* 中断向量表（2020）：中断服务程序入口



**DMA方式**（Direct Memory Access）：

* DMA控制器管理传输

* 传输过程不占用CPU

* DMA传送程序（2021-2025）：设置传输参数



**通道方式**（2009）：

* I/O处理器执行通道程序

* 进一步减轻CPU负担



### I/O软件层次



**用户层I/O软件**（2012）：

* 库函数封装系统调用

* SPOOLing技术（2016）：假脱机



**设备无关软件层**（2012）：

* 设备驱动程序接口

* 缓冲管理、错误处理

* 设备无关性（2015）：应用程序不依赖具体设备



**设备驱动程序**（2019）：

* 与硬件设备通信

* 中断处理程序（2024）



**中断处理程序**：

* 保存现场

* 分析中断原因

* 调用相应处理程序

* 恢复现场



### 设备分配与缓冲



**设备分类**：

* **独占设备**（2016）：打印机等

* **共享设备**：磁盘等

* **虚拟设备**：通过SPOOLing实现



**设备分配数据结构**：

* 设备控制表（DCT）

* 控制器控制表（COCT）

* 通道控制表（CHCT）

* 系统设备表（SDT）



**缓冲技术**：

1. **单缓冲**（2011）：一个缓冲区

2. **双缓冲**（2011）：两个缓冲区交替使用

3. **循环缓冲**：多个缓冲区循环使用

4. **缓冲池**：多个缓冲区，统一管理



**SPOOLing系统**（2016）：

* 输入井、输出井（2016）

* 输入进程、输出进程

* 实现虚拟设备